<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/1999/REC-html401-19991224/strict.dtd">
<html>
<head>
<META http-equiv=Content-Type content="text/html; charset=UTF-8">
<title>Exported from Notepad++</title>
<style type="text/css">
span {
	font-family: 'Courier New';
	font-size: 10pt;
	color: #000000;
}
.sc0 {
}
.sc1 {
	color: #008000;
}
.sc2 {
	font-weight: bold;
	color: #0000FF;
}
.sc3 {
	color: #8000FF;
}
.sc5 {
	color: #FF8000;
}
.sc6 {
	color: #808080;
}
.sc8 {
	font-weight: bold;
	color: #000080;
}
.sc9 {
}
.sc10 {
	color: #804000;
}
</style>
</head>
<body>
<div style="float: left; white-space: pre; line-height: 1; background: #FFFFFF; "><span class="sc1">## FESTA algorithm</span><span class="sc0">
</span><span class="sc1"># Load required packages and utility functions</span><span class="sc0">
</span><span class="sc3">require</span><span class="sc8">(</span><span class="sc9">amap</span><span class="sc8">)</span><span class="sc0">
</span><span class="sc3">require</span><span class="sc8">(</span><span class="sc9">plyr</span><span class="sc8">)</span><span class="sc0">

</span><span class="sc1">##### Splicing detection</span><span class="sc0">
</span><span class="sc1">##### Cluster genes according to reciprocal correlations, then iteratively cut tree (bottom up) until one cluster is the most expressed or tied for expression across all samples. Uses hcluster from amap package for clustering</span><span class="sc0">

</span><span class="sc1">## Required input data:</span><span class="sc0">
</span><span class="sc1">## data.frame with one row per exon and one column per sample, plus </span><span class="sc0">
</span><span class="sc1">## "geneID" column with unique gene identifier</span><span class="sc0">
</span><span class="sc1">## "exonID" column with unique exon identifier</span><span class="sc0">

</span><span class="sc1"># Example data</span><span class="sc0">
</span><span class="sc1"># geneID &lt;- paste("gene",100:500, sep = "")</span><span class="sc0">
</span><span class="sc1"># exonID &lt;- paste(merge(geneID,c(1:10))[,1], merge(geneID,c(1:10))[,2],sep = "exon")</span><span class="sc0">
</span><span class="sc1"># exprData &lt;- matrix(log2(rbinom(n = 4010*10, size = 1000, prob = .3)), ncol = 10)</span><span class="sc0">
</span><span class="sc1"># exampleData &lt;- data.frame(geneID = geneID, </span><span class="sc0">
</span><span class="sc1">#                           exonID = exonID, </span><span class="sc0">
</span><span class="sc1">#                           Evalue = exprData)</span><span class="sc0">

</span><span class="sc1">## Parameter description</span><span class="sc0">
</span><span class="sc1">## exceptions: </span><span class="sc0">
</span><span class="sc1">## signDigits: number of digits rounded from expression scores for ranking calculations</span><span class="sc0">
</span><span class="sc1">## distMethod: distance metric used by the clustering algorithm (default: correlation), see function hcluster from package amap for more information</span><span class="sc0">
</span><span class="sc1">## link: agglomeration method used by the clustering algorithm (default: complete), see function hcluster from package amap for more information</span><span class="sc0">
</span><span class="sc1">## nbproc: number of subprocess for parallelization (default: 1), see function hcluster from package amap for more information</span><span class="sc0">

</span><span class="sc9">ClusterExons</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc2">function</span><span class="sc8">(</span><span class="sc3">data</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc2">NULL</span><span class="sc0">, </span><span class="sc9">exceptions</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">ceiling</span><span class="sc8">(</span><span class="sc9">x</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc3">ncol</span><span class="sc8">(</span><span class="sc3">data</span><span class="sc8">)-</span><span class="sc5">2</span><span class="sc8">)*</span><span class="sc5">.1</span><span class="sc8">)</span><span class="sc0">, </span><span class="sc9">signDigits</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc5">3</span><span class="sc0">, </span><span class="sc9">distMethod</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc6">"correlation"</span><span class="sc0">, </span><span class="sc9">link</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc6">"complete"</span><span class="sc0">, </span><span class="sc9">nbproc</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc5">1</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">{</span><span class="sc0">
  </span><span class="sc3">require</span><span class="sc8">(</span><span class="sc9">amap</span><span class="sc8">)</span><span class="sc0">
  </span><span class="sc3">require</span><span class="sc8">(</span><span class="sc9">plyr</span><span class="sc8">)</span><span class="sc0">
  </span><span class="sc9">ExonAssTable</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc3">list</span><span class="sc8">()</span><span class="sc0">
  </span><span class="sc9">exceptions</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc9">exceptions</span><span class="sc8">/(</span><span class="sc3">ncol</span><span class="sc8">(</span><span class="sc3">data</span><span class="sc8">)-</span><span class="sc5">2</span><span class="sc8">)</span><span class="sc0">
  </span><span class="sc9">row.names</span><span class="sc8">(</span><span class="sc3">data</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc3">data</span><span class="sc8">$</span><span class="sc9">exonID</span><span class="sc0">
  </span><span class="sc2">for</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc9">gID</span><span class="sc0"> </span><span class="sc2">in</span><span class="sc0"> </span><span class="sc3">unique</span><span class="sc8">(</span><span class="sc3">data</span><span class="sc8">$</span><span class="sc9">geneID</span><span class="sc8">)){</span><span class="sc0">
    </span><span class="sc9">Evalues</span><span class="sc8">&lt;-</span><span class="sc3">data</span><span class="sc8">[</span><span class="sc3">which</span><span class="sc8">(</span><span class="sc3">data</span><span class="sc8">$</span><span class="sc9">geneID</span><span class="sc10">%in%</span><span class="sc9">gID</span><span class="sc8">)</span><span class="sc0">,</span><span class="sc8">-</span><span class="sc3">grep</span><span class="sc8">(</span><span class="sc9">pattern</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc6">"ID"</span><span class="sc0">,</span><span class="sc9">x</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">names</span><span class="sc8">(</span><span class="sc3">data</span><span class="sc8">))]</span><span class="sc0">
    </span><span class="sc2">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc3">nrow</span><span class="sc8">(</span><span class="sc9">Evalues</span><span class="sc8">)&lt;</span><span class="sc5">2</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">{</span><span class="sc0">
      </span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]]&lt;-</span><span class="sc9">as.data.frame</span><span class="sc8">(</span><span class="sc3">matrix</span><span class="sc8">(</span><span class="sc9">row.names</span><span class="sc8">(</span><span class="sc9">Evalues</span><span class="sc8">)</span><span class="sc0">, </span><span class="sc3">ncol</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc5">1</span><span class="sc8">))</span><span class="sc0">
      </span><span class="sc3">names</span><span class="sc8">(</span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]])&lt;-</span><span class="sc6">"exonID"</span><span class="sc0">
      </span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]]$</span><span class="sc9">splicing_category</span><span class="sc8">&lt;-</span><span class="sc6">"single_expressed_exon"</span><span class="sc0">
      </span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]]$</span><span class="sc9">clusters</span><span class="sc8">&lt;-</span><span class="sc5">0</span><span class="sc0">
      </span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]]$</span><span class="sc9">clusterranks</span><span class="sc8">&lt;-</span><span class="sc5">1</span><span class="sc0">
      </span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]]&lt;-</span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]][</span><span class="sc3">c</span><span class="sc8">(</span><span class="sc6">"clusters"</span><span class="sc0">, </span><span class="sc6">"exonID"</span><span class="sc0">, </span><span class="sc6">"clusterranks"</span><span class="sc0">, </span><span class="sc6">"splicing_category"</span><span class="sc8">)]</span><span class="sc0">
    </span><span class="sc8">}</span><span class="sc0"> </span><span class="sc2">else</span><span class="sc0"> </span><span class="sc8">{</span><span class="sc0">
      </span><span class="sc9">tree</span><span class="sc8">&lt;-</span><span class="sc9">hcluster</span><span class="sc8">(</span><span class="sc9">Evalues</span><span class="sc0">, </span><span class="sc9">method</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">distMethod</span><span class="sc0">, </span><span class="sc9">link</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">link</span><span class="sc0">, </span><span class="sc9">nbproc</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">nbproc</span><span class="sc8">)</span><span class="sc0">
      </span><span class="sc2">for</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc9">trans</span><span class="sc0"> </span><span class="sc2">in</span><span class="sc0"> </span><span class="sc3">nrow</span><span class="sc8">(</span><span class="sc9">Evalues</span><span class="sc8">):</span><span class="sc5">1</span><span class="sc8">){</span><span class="sc0">
        </span><span class="sc1"># evaluate relative times it is ranked as first</span><span class="sc0">
        </span><span class="sc9">Evalues</span><span class="sc8">$</span><span class="sc9">clusters</span><span class="sc8">&lt;-</span><span class="sc3">cutree</span><span class="sc8">(</span><span class="sc9">tree</span><span class="sc0">, </span><span class="sc9">k</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">trans</span><span class="sc8">)</span><span class="sc0">
        </span><span class="sc9">clusterranks</span><span class="sc8">&lt;-</span><span class="sc9">ddply</span><span class="sc8">(</span><span class="sc9">Evalues</span><span class="sc0">, .</span><span class="sc8">(</span><span class="sc9">clusters</span><span class="sc8">)</span><span class="sc0">, </span><span class="sc9">colwise</span><span class="sc8">(</span><span class="sc3">median</span><span class="sc8">))</span><span class="sc0">
        </span><span class="sc2">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc3">nrow</span><span class="sc8">(</span><span class="sc9">clusterranks</span><span class="sc8">)==</span><span class="sc5">1</span><span class="sc8">){</span><span class="sc0"> </span><span class="sc1"># there are no subranking isoforms</span><span class="sc0">
          </span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]]&lt;-</span><span class="sc9">as.data.frame</span><span class="sc8">(</span><span class="sc3">matrix</span><span class="sc8">(</span><span class="sc9">row.names</span><span class="sc8">(</span><span class="sc9">Evalues</span><span class="sc8">)</span><span class="sc0">, </span><span class="sc3">ncol</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc5">1</span><span class="sc8">))</span><span class="sc0">
          </span><span class="sc3">names</span><span class="sc8">(</span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]])&lt;-</span><span class="sc6">"exonID"</span><span class="sc0">
          </span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]]$</span><span class="sc9">clusters</span><span class="sc8">&lt;-</span><span class="sc5">0</span><span class="sc0">
          </span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]]$</span><span class="sc9">clusterranks</span><span class="sc8">&lt;-</span><span class="sc5">1</span><span class="sc0">
          </span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]]$</span><span class="sc9">splicing_category</span><span class="sc8">&lt;-</span><span class="sc6">"unspliced"</span><span class="sc0">
          </span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]]&lt;-</span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]][</span><span class="sc3">c</span><span class="sc8">(</span><span class="sc6">"clusters"</span><span class="sc0">, </span><span class="sc6">"exonID"</span><span class="sc0">, </span><span class="sc6">"clusterranks"</span><span class="sc0">, </span><span class="sc6">"splicing_category"</span><span class="sc8">)]</span><span class="sc0">
          </span><span class="sc2">break</span><span class="sc8">}</span><span class="sc0"> </span><span class="sc2">else</span><span class="sc0"> </span><span class="sc8">{</span><span class="sc0">
            </span><span class="sc9">clusterranks</span><span class="sc8">&lt;-</span><span class="sc3">apply</span><span class="sc8">(</span><span class="sc9">clusterranks</span><span class="sc8">[</span><span class="sc0">,</span><span class="sc8">-</span><span class="sc5">1</span><span class="sc8">]</span><span class="sc0">, </span><span class="sc5">2</span><span class="sc0">, </span><span class="sc2">function</span><span class="sc8">(</span><span class="sc9">x</span><span class="sc8">){</span><span class="sc3">rank</span><span class="sc8">(-</span><span class="sc3">round</span><span class="sc8">(</span><span class="sc9">x</span><span class="sc0">, </span><span class="sc9">digits</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">signDigits</span><span class="sc8">)</span><span class="sc0">, </span><span class="sc9">ties.method</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc6">"min"</span><span class="sc0">, </span><span class="sc9">na.last</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">T</span><span class="sc8">)})</span><span class="sc0">
            </span><span class="sc9">row.names</span><span class="sc8">(</span><span class="sc9">clusterranks</span><span class="sc8">)&lt;-</span><span class="sc3">unique</span><span class="sc8">(</span><span class="sc9">Evalues</span><span class="sc8">$</span><span class="sc9">cluster</span><span class="sc8">)</span><span class="sc0">
            </span><span class="sc9">clusterranks</span><span class="sc8">&lt;-</span><span class="sc3">apply</span><span class="sc8">(</span><span class="sc9">clusterranks</span><span class="sc0">, </span><span class="sc5">1</span><span class="sc0">, </span><span class="sc2">function</span><span class="sc8">(</span><span class="sc9">x</span><span class="sc8">){</span><span class="sc3">sum</span><span class="sc8">(</span><span class="sc9">x</span><span class="sc8">==</span><span class="sc5">1</span><span class="sc8">)/</span><span class="sc3">ncol</span><span class="sc8">(</span><span class="sc9">clusterranks</span><span class="sc8">)})</span><span class="sc0">
            </span><span class="sc2">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc3">sum</span><span class="sc8">((</span><span class="sc9">clusterranks</span><span class="sc8">)&gt;=(</span><span class="sc5">1</span><span class="sc8">-</span><span class="sc9">exceptions</span><span class="sc8">))==</span><span class="sc5">1</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">{</span><span class="sc0"> </span><span class="sc1"># control that there is only one exon group which consistently ranks 1st or tied allowing for exceptions</span><span class="sc0">
              </span><span class="sc9">matchmaker</span><span class="sc8">&lt;-</span><span class="sc9">Evalues</span><span class="sc8">[</span><span class="sc0">,</span><span class="sc6">"clusters"</span><span class="sc0">, </span><span class="sc3">drop</span><span class="sc8">=</span><span class="sc9">F</span><span class="sc8">]</span><span class="sc0"> </span><span class="sc1"># create table with exon subcluster assignments</span><span class="sc0">
              </span><span class="sc9">clusters</span><span class="sc8">&lt;-</span><span class="sc9">as.data.frame</span><span class="sc8">(</span><span class="sc9">clusterranks</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc1"># store subcluster ranks</span><span class="sc0">
              </span><span class="sc9">clusters</span><span class="sc8">$</span><span class="sc9">clusters</span><span class="sc8">&lt;-</span><span class="sc3">c</span><span class="sc8">(</span><span class="sc5">1</span><span class="sc8">:</span><span class="sc3">nrow</span><span class="sc8">(</span><span class="sc9">clusters</span><span class="sc8">))</span><span class="sc0"> </span><span class="sc1">#annotate subcluster ranks with subcluster IDs</span><span class="sc0">
              </span><span class="sc9">matchmaker</span><span class="sc8">&lt;-</span><span class="sc9">join</span><span class="sc8">(</span><span class="sc9">matchmaker</span><span class="sc0">, </span><span class="sc9">clusters</span><span class="sc0">, </span><span class="sc3">by</span><span class="sc8">=</span><span class="sc6">"clusters"</span><span class="sc0">, </span><span class="sc9">type</span><span class="sc8">=</span><span class="sc6">"left"</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc1"># merge exon with subcluster ID and ranks</span><span class="sc0">
              </span><span class="sc9">row.names</span><span class="sc8">(</span><span class="sc9">matchmaker</span><span class="sc8">)&lt;-</span><span class="sc9">row.names</span><span class="sc8">(</span><span class="sc9">Evalues</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc1"># add exon names</span><span class="sc0">
              </span><span class="sc9">matchmaker</span><span class="sc8">$</span><span class="sc9">exonID</span><span class="sc8">&lt;-</span><span class="sc9">row.names</span><span class="sc8">(</span><span class="sc9">matchmaker</span><span class="sc8">)</span><span class="sc0">
              </span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]]&lt;-</span><span class="sc9">matchmaker</span><span class="sc0">
              </span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]]$</span><span class="sc9">splicing_category</span><span class="sc8">&lt;-</span><span class="sc6">"spliced"</span><span class="sc0">
              </span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]]&lt;-</span><span class="sc9">ExonAssTable</span><span class="sc8">[[</span><span class="sc9">gID</span><span class="sc8">]][</span><span class="sc3">c</span><span class="sc8">(</span><span class="sc6">"clusters"</span><span class="sc0">, </span><span class="sc6">"exonID"</span><span class="sc0">, </span><span class="sc6">"clusterranks"</span><span class="sc0">, </span><span class="sc6">"splicing_category"</span><span class="sc8">)]</span><span class="sc0">
              </span><span class="sc2">break</span><span class="sc8">}</span><span class="sc0"> </span><span class="sc2">else</span><span class="sc0"> </span><span class="sc8">{</span><span class="sc2">next</span><span class="sc8">}}}</span><span class="sc0">
    </span><span class="sc8">}</span><span class="sc0">
  </span><span class="sc8">}</span><span class="sc0">
  
  </span><span class="sc1"># this step causes problem in R below version 2</span><span class="sc0">
  </span><span class="sc9">ExonAssTable</span><span class="sc8">&lt;-</span><span class="sc9">ldply</span><span class="sc8">(</span><span class="sc9">ExonAssTable</span><span class="sc0">,</span><span class="sc3">rbind</span><span class="sc8">)</span><span class="sc0"> 
  </span><span class="sc3">names</span><span class="sc8">(</span><span class="sc9">ExonAssTable</span><span class="sc8">)[</span><span class="sc5">1</span><span class="sc8">]&lt;-</span><span class="sc6">"geneID"</span><span class="sc0">
  </span><span class="sc1"># assign constitutive/specific status</span><span class="sc0">
  </span><span class="sc9">ExonAssTable</span><span class="sc8">$</span><span class="sc9">constitutive</span><span class="sc8">&lt;-</span><span class="sc3">ifelse</span><span class="sc8">((</span><span class="sc9">ExonAssTable</span><span class="sc8">$</span><span class="sc9">clusterranks</span><span class="sc8">&gt;=(</span><span class="sc5">1</span><span class="sc8">-</span><span class="sc9">exceptions</span><span class="sc8">))</span><span class="sc0">,</span><span class="sc6">"constitutive"</span><span class="sc0">,</span><span class="sc6">"facultative"</span><span class="sc8">)</span><span class="sc0">
  </span><span class="sc1"># merge cluster assignments into unique IDs with designation of constitutiveness </span><span class="sc0">
  </span><span class="sc9">ExonAssTable</span><span class="sc8">$</span><span class="sc9">transcriptID</span><span class="sc8">&lt;-</span><span class="sc9">as.factor</span><span class="sc8">(</span><span class="sc9">paste0</span><span class="sc8">(</span><span class="sc9">ExonAssTable</span><span class="sc8">$</span><span class="sc9">geneID</span><span class="sc0">, </span><span class="sc6">"_t"</span><span class="sc0">, </span><span class="sc9">ExonAssTable</span><span class="sc8">$</span><span class="sc9">clusters</span><span class="sc0">, </span><span class="sc3">ifelse</span><span class="sc8">(</span><span class="sc9">ExonAssTable</span><span class="sc8">$</span><span class="sc9">constitutive</span><span class="sc8">==</span><span class="sc6">"constitutive"</span><span class="sc0">, </span><span class="sc6">"_con"</span><span class="sc0">,</span><span class="sc6">"_fac"</span><span class="sc8">)</span><span class="sc0">, </span><span class="sc9">sep</span><span class="sc8">=</span><span class="sc6">""</span><span class="sc8">))</span><span class="sc0">
  </span><span class="sc1"># code ID variables as factors</span><span class="sc0">
  </span><span class="sc9">ExonAssTable</span><span class="sc8">$</span><span class="sc9">geneID</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc9">as.factor</span><span class="sc8">(</span><span class="sc9">ExonAssTable</span><span class="sc8">$</span><span class="sc9">geneID</span><span class="sc8">)</span><span class="sc0">
  </span><span class="sc9">ExonAssTable</span><span class="sc8">$</span><span class="sc9">splicing_category</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc9">as.factor</span><span class="sc8">(</span><span class="sc9">ExonAssTable</span><span class="sc8">$</span><span class="sc9">splicing_category</span><span class="sc8">)</span><span class="sc0">
  </span><span class="sc9">ExonAssTable</span><span class="sc8">$</span><span class="sc9">constitutive</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc9">as.factor</span><span class="sc8">(</span><span class="sc9">ExonAssTable</span><span class="sc8">$</span><span class="sc9">constitutive</span><span class="sc8">)</span><span class="sc0">
  </span><span class="sc9">ExonAssTable</span><span class="sc0">
</span><span class="sc8">}</span><span class="sc0">



</span><span class="sc1">##### Average expression values based on unique eigenexon IDs</span><span class="sc0">

</span><span class="sc1">## Required input data:</span><span class="sc0">
</span><span class="sc1">## data.frame with one row per exon and one column per sample, plus </span><span class="sc0">
</span><span class="sc1">## "geneID" column with unique gene identifier</span><span class="sc0">
</span><span class="sc1">## "transcriptID" column with unique exon identifier as per assigned via ClusterExons</span><span class="sc0">
</span><span class="sc1">## "constitutive" column identifying which transcripts are from constitutive nodes as per assigned via ClusterExons</span><span class="sc0">

</span><span class="sc1">## Parameter description:</span><span class="sc0">
</span><span class="sc1">## splicingRatios: Logical. If FALSE, expression from all entries is reported on the same scale. If TRUE, expression from splicing entries is normalized by their gene's constitutive expression score, generating splicing ratios</span><span class="sc0">
</span><span class="sc1">## NAcorrection: Logical. Applicable only if splicingRatios is TRUE. If TRUE, splicing ratios higher than 1 are set to 1 and NA/NaN/infinity values to 0. This accounts for experimental error in measurements.</span><span class="sc0">

</span><span class="sc9">AverageExons</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc2">function</span><span class="sc8">(</span><span class="sc3">data</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc2">NULL</span><span class="sc0">, </span><span class="sc9">splicingRatios</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">F</span><span class="sc0">, </span><span class="sc9">NAcorrection</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">F</span><span class="sc8">){</span><span class="sc0">
  </span><span class="sc2">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc9">splicingRatios</span><span class="sc0"> </span><span class="sc8">==</span><span class="sc0"> </span><span class="sc9">F</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">{</span><span class="sc0">
    </span><span class="sc9">out</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc9">ddply</span><span class="sc8">(</span><span class="sc0">.</span><span class="sc3">data</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">data</span><span class="sc0">, .</span><span class="sc9">variables</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> .</span><span class="sc8">(</span><span class="sc9">transcriptID</span><span class="sc8">)</span><span class="sc0">, </span><span class="sc9">numcolwise</span><span class="sc8">(</span><span class="sc3">median</span><span class="sc8">)</span><span class="sc0">, </span><span class="sc9">na.rm</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">T</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">out</span><span class="sc8">[</span><span class="sc3">order</span><span class="sc8">(</span><span class="sc9">out</span><span class="sc8">$</span><span class="sc9">transcriptID</span><span class="sc8">)</span><span class="sc0">,</span><span class="sc8">]</span><span class="sc0">
  </span><span class="sc8">}</span><span class="sc0"> </span><span class="sc2">else</span><span class="sc0"> </span><span class="sc8">{</span><span class="sc0">
    </span><span class="sc1">## split into constitutives and facultatives</span><span class="sc0">
    </span><span class="sc9">ConTranscripts</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc3">data</span><span class="sc8">[</span><span class="sc3">which</span><span class="sc8">(</span><span class="sc3">data</span><span class="sc8">$</span><span class="sc9">constitutive</span><span class="sc8">==</span><span class="sc6">"constitutive"</span><span class="sc8">)</span><span class="sc0">,</span><span class="sc8">]</span><span class="sc0">
    </span><span class="sc9">FacTranscripts</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc3">data</span><span class="sc8">[</span><span class="sc3">which</span><span class="sc8">(</span><span class="sc3">data</span><span class="sc8">$</span><span class="sc9">constitutive</span><span class="sc8">!=</span><span class="sc6">"constitutive"</span><span class="sc8">)</span><span class="sc0">,</span><span class="sc8">]</span><span class="sc0">
    </span><span class="sc1">## average exon values within transcripts</span><span class="sc0">
    </span><span class="sc9">ConTranscripts</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc9">ddply</span><span class="sc8">(</span><span class="sc9">ConTranscripts</span><span class="sc0">, .</span><span class="sc9">variables</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> .</span><span class="sc8">(</span><span class="sc9">geneID</span><span class="sc0">, </span><span class="sc9">transcriptID</span><span class="sc8">)</span><span class="sc0">, </span><span class="sc9">numcolwise</span><span class="sc8">(</span><span class="sc3">median</span><span class="sc8">)</span><span class="sc0">, </span><span class="sc9">na.rm</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">T</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">FacTranscripts</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc9">ddply</span><span class="sc8">(</span><span class="sc9">FacTranscripts</span><span class="sc0">, .</span><span class="sc9">variables</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> .</span><span class="sc8">(</span><span class="sc9">geneID</span><span class="sc0">, </span><span class="sc9">transcriptID</span><span class="sc8">)</span><span class="sc0">, </span><span class="sc9">numcolwise</span><span class="sc8">(</span><span class="sc3">median</span><span class="sc8">)</span><span class="sc0">, </span><span class="sc9">na.rm</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc9">T</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">FacSplicing</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc3">apply</span><span class="sc8">(</span><span class="sc9">FacTranscripts</span><span class="sc0">, </span><span class="sc5">1</span><span class="sc0">, </span><span class="sc2">function</span><span class="sc8">(</span><span class="sc9">Fac</span><span class="sc8">){</span><span class="sc0">
      </span><span class="sc9">Spl</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc9">as.numeric</span><span class="sc8">(</span><span class="sc9">Fac</span><span class="sc8">[-</span><span class="sc3">grep</span><span class="sc8">(</span><span class="sc9">pattern</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc6">"ID"</span><span class="sc0">, </span><span class="sc9">x</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">names</span><span class="sc8">(</span><span class="sc9">FacTranscripts</span><span class="sc8">))])</span><span class="sc0">
      </span><span class="sc9">Con</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc9">ConTranscripts</span><span class="sc8">[</span><span class="sc3">which</span><span class="sc8">(</span><span class="sc9">Fac</span><span class="sc8">[</span><span class="sc6">"geneID"</span><span class="sc8">]==</span><span class="sc9">ConTranscripts</span><span class="sc8">$</span><span class="sc9">geneID</span><span class="sc8">)</span><span class="sc0">,</span><span class="sc8">-</span><span class="sc3">grep</span><span class="sc8">(</span><span class="sc9">pattern</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc6">"ID"</span><span class="sc0">, </span><span class="sc9">x</span><span class="sc0"> </span><span class="sc8">=</span><span class="sc0"> </span><span class="sc3">names</span><span class="sc8">(</span><span class="sc9">ConTranscripts</span><span class="sc8">))]</span><span class="sc0">
      </span><span class="sc9">Spl</span><span class="sc8">/</span><span class="sc9">Con</span><span class="sc0">
    </span><span class="sc8">})</span><span class="sc0">
    </span><span class="sc9">FacSplicing</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc3">cbind</span><span class="sc8">(</span><span class="sc9">FacTranscripts</span><span class="sc8">[</span><span class="sc0">,</span><span class="sc3">c</span><span class="sc8">(</span><span class="sc6">"geneID"</span><span class="sc0">,</span><span class="sc6">"transcriptID"</span><span class="sc8">)]</span><span class="sc0">,</span><span class="sc9">ldply</span><span class="sc8">(</span><span class="sc9">FacSplicing</span><span class="sc8">))</span><span class="sc0">
    </span><span class="sc2">if</span><span class="sc0"> </span><span class="sc8">(</span><span class="sc9">NAcorr</span><span class="sc0"> </span><span class="sc8">==</span><span class="sc0"> </span><span class="sc9">T</span><span class="sc8">)</span><span class="sc0"> </span><span class="sc8">{</span><span class="sc0">
      </span><span class="sc1"># set NA/NaN and infinity scores to 0, set scores greater than 1 to 1</span><span class="sc0">
      </span><span class="sc9">FacSplicing</span><span class="sc8">[</span><span class="sc0">,</span><span class="sc3">sapply</span><span class="sc8">(</span><span class="sc9">FacSplicing</span><span class="sc0">, </span><span class="sc9">is.numeric</span><span class="sc8">)]&lt;-</span><span class="sc3">apply</span><span class="sc8">(</span><span class="sc9">FacSplicing</span><span class="sc8">[</span><span class="sc0">,</span><span class="sc3">sapply</span><span class="sc8">(</span><span class="sc9">FacSplicing</span><span class="sc0">, </span><span class="sc9">is.numeric</span><span class="sc8">)]</span><span class="sc0">,</span><span class="sc3">c</span><span class="sc8">(</span><span class="sc5">1</span><span class="sc0">,</span><span class="sc5">2</span><span class="sc8">)</span><span class="sc0">,</span><span class="sc2">function</span><span class="sc8">(</span><span class="sc9">x</span><span class="sc8">){</span><span class="sc9">as.numeric</span><span class="sc8">(</span><span class="sc3">ifelse</span><span class="sc8">(</span><span class="sc9">is.na</span><span class="sc8">(</span><span class="sc9">x</span><span class="sc8">)</span><span class="sc0">, </span><span class="sc5">0</span><span class="sc0">, </span><span class="sc9">x</span><span class="sc8">))})</span><span class="sc0">
      </span><span class="sc9">FacSplicing</span><span class="sc8">[</span><span class="sc0">,</span><span class="sc3">sapply</span><span class="sc8">(</span><span class="sc9">FacSplicing</span><span class="sc0">, </span><span class="sc9">is.numeric</span><span class="sc8">)]&lt;-</span><span class="sc3">apply</span><span class="sc8">(</span><span class="sc9">FacSplicing</span><span class="sc8">[</span><span class="sc0">,</span><span class="sc3">sapply</span><span class="sc8">(</span><span class="sc9">FacSplicing</span><span class="sc0">, </span><span class="sc9">is.numeric</span><span class="sc8">)]</span><span class="sc0">,</span><span class="sc3">c</span><span class="sc8">(</span><span class="sc5">1</span><span class="sc0">,</span><span class="sc5">2</span><span class="sc8">)</span><span class="sc0">,</span><span class="sc2">function</span><span class="sc8">(</span><span class="sc9">x</span><span class="sc8">){</span><span class="sc9">as.numeric</span><span class="sc8">(</span><span class="sc3">ifelse</span><span class="sc8">(</span><span class="sc9">x</span><span class="sc8">&gt;</span><span class="sc5">1</span><span class="sc0">, </span><span class="sc5">1</span><span class="sc0">, </span><span class="sc9">x</span><span class="sc8">))})</span><span class="sc0">
    </span><span class="sc8">}</span><span class="sc0">
    </span><span class="sc9">out</span><span class="sc0"> </span><span class="sc8">&lt;-</span><span class="sc0"> </span><span class="sc3">rbind</span><span class="sc8">(</span><span class="sc9">ConTranscripts</span><span class="sc0">,</span><span class="sc9">FacSplicing</span><span class="sc8">)</span><span class="sc0">
    </span><span class="sc9">out</span><span class="sc8">[</span><span class="sc3">order</span><span class="sc8">(</span><span class="sc9">out</span><span class="sc8">$</span><span class="sc9">transcriptID</span><span class="sc8">)</span><span class="sc0">,</span><span class="sc8">]</span><span class="sc0">
  </span><span class="sc8">}</span><span class="sc0">
</span><span class="sc8">}</span></div></body>
</html>
